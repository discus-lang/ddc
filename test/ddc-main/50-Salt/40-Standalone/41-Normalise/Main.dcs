
module Main
exports {
         main     :: [r1 : %]. Nat# -> Ptr# r1 String# -> Int#;
}
imports {
        showInt   :: [r : %]. Int# -> Ptr# r String#;
        putStrLn  :: [r : %]. Ptr# r String# -> Void#;
}
with letrec {

allocRaw [r : %] (tag : Tag#) (bytesPayload : Nat#) : Ptr# r Obj
 = do { bytesObj        = add# [Nat#] 8# bytesPayload;
        addr            = alloc# bytesObj;

        format          = 42w32#;
        tag32           = promote# [Word32#] [Tag#] tag;
        tagShift        = shl# [Word32#] tag32 8w32#;
        header          = bor# [Word32#] tagShift format;
        write# [Word32#] addr 0# header;

        bytesObj32      = truncate# [Word32#] [Nat#] bytesObj;
        write# [Word32#] addr 4# bytesObj32;

        return# [Ptr# r Obj] (makePtr# [r] [Obj] addr);
     };


boxWord32 [r : %] (x : Word32#) : Ptr# r Obj
 = do { obj     = allocRaw [r] TAG0# 4#;
        addr    = takePtr# [r] [Obj] obj;
        write#  [Word32#] addr 8# x;
        return# [Ptr# r Obj] obj;
      };


unboxWord32 [r : %] (obj : Ptr# r Obj) : Word32#
 = do { addr    = takePtr# [r] [Obj] obj;
        x       = read#   [Word32#] addr 8#;
        return# [Word32#] x;
      };


addWord32 [r : %] (x : Ptr# r Obj) (y : Ptr# r Obj) : Ptr# r Obj
 = return# [Ptr# r Obj] (boxWord32 [r] (add# [Word32#] (unboxWord32 [r] x) (unboxWord32 [r] y)));


subWord32 [r : %] (x : Ptr# r Obj) (y : Ptr# r Obj) : Ptr# r Obj
 = return# [Ptr# r Obj] (boxWord32 [r] (sub# [Word32#] (unboxWord32 [r] x) (unboxWord32 [r] y)));


mulWord32 [r : %] (x : Ptr# r Obj) (y : Ptr# r Obj) : Ptr# r Obj
 = return# [Ptr# r Obj] (boxWord32 [r] (mul# [Word32#] (unboxWord32 [r] x) (unboxWord32 [r] y)));


fac [r : %] (x: Ptr# r Obj) : Ptr# r Obj
 = do { cc      = eq# [Word32#] (unboxWord32 [r] x) 0w32#;
        case cc of {
         True#  -> return# [Ptr# r Obj] (boxWord32 [r] 1w32#);
         False# -> return# [Ptr# r Obj] (mulWord32 [r] x (fac [r] (subWord32 [r] x (boxWord32 [r] 1w32#))));
        };
      };


main [r : %] (argc : Nat#) (argv : Ptr# r String#) : Int#
 = do { create# 1000#;
        x       = boxWord32 [r] 10w32#;
        str     = showInt [r] (truncate# [Int#] [Word32#] (unboxWord32 [r] (fac [r] x)));
        putStrLn [r] str;

        return# [Int#] 0i#;
      };
}
